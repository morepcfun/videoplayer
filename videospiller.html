<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Videospiller for Chromebook</title>
<style>
body {
margin: 0;
background-color: #000;
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
overflow: hidden;
}
#video-player {
width: 100vw;
height: 100vh;
object-fit: contain;
position: absolute;
top: 0;
left: 0;
z-index: 1;
background-color: #000;
}
.controls-panel {
position: fixed;
bottom: 2rem;
left: 50%;
transform: translateX(-50%);
z-index: 10;
display: flex;
flex-direction: row;
align-items: center;
gap: 20px;
width: auto;
background-color: rgba(30, 30, 30, 0.8);
padding: 1rem 1.5rem;
border-radius: 12px;
backdrop-filter: blur(5px);
transition: opacity 0.4s ease-in-out, visibility 0.4s;
box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}
.controls-panel.hidden {
opacity: 0;
visibility: hidden;
pointer-events: none;
}
.btn {
font-weight: bold;
cursor: pointer;
color: white;
padding: 12px 18px;
border-radius: 6px;
text-align: center;
transition: background-color 0.2s ease, transform 0.1s ease;
user-select: none;
}
.btn:hover {
filter: brightness(1.1);
}
.btn:active {
transform: scale(0.98);
}
.main-label {
background-color: #007bff;
}
input[type="file"] {
display: none;
}
.volume-controls {
display: flex;
align-items: center;
gap: 10px;
}
.volume-controls label {
font-size: 1.5rem;
font-weight: normal;
cursor: default;
color: #fff;
}
#volume-level {
font-weight: bold;
color: #00e0ff;
margin-left: 8px;
min-width: 50px;
text-align: left;
}
.volume-slider {
width: 100px;
}
</style>
</head>
<body>
<video id="video-player" controls crossOrigin="anonymous" autoplay>
<track kind="subtitles" srclang="no" label="Norsk" default>
</video>
<div class="controls-panel">
<label for="file-upload" class="btn main-label" id="choose-files-btn"></label>
<input type="file" id="file-upload" accept=".mp4,.mkv,.srt" multiple>
<div class="volume-controls">
<label for="volume-booster">ðŸ”Š<b id="volume-level">100%</b></label>
<input type="range" id="volume-booster" class="volume-slider" min="1" max="4" step="0.1" value="1" title="Volumforsterker">
</div>
</div>
<script>
const lang = {
    title: "Videospiller for Chromebook",
    chooseFiles: "Velg Filer",
    subtitleLabel: "Norsk",
    noTrackError: "Fant ingen tekst-spor pÃ¥ videoelementet.",
    noVideoOnClipboard: "Fant ikke noe bilde pÃ¥ utklippstavlen.",
    pasteError: "Kunne ikke lime inn. Sjekk konsollen for feilmelding."
};

document.title = lang.title;

const videoPlayer = document.getElementById('video-player');
const fileUpload = document.getElementById('file-upload');
const volumeBooster = document.getElementById('volume-booster');
const volumeLevel = document.getElementById('volume-level');
const controlsPanel = document.querySelector('.controls-panel');
let inactivityTimeout;
let videoUrl = null;
let audioContext, gainNode;

function updateStaticUIText() {
    document.getElementById('choose-files-btn').textContent = lang.chooseFiles;
    const trackElement = videoPlayer.querySelector('track');
    if (trackElement) trackElement.label = lang.subtitleLabel;
}

function handleFiles(files) {
    if (files.length === 0) return;
    const filesArray = Array.from(files);
    
    const videoFile = filesArray.find(f => f.name.toLowerCase().endsWith('.mp4') || f.name.toLowerCase().endsWith('.mkv'));
    const srtFile = filesArray.find(f => f.name.toLowerCase().endsWith('.srt'));

    if (videoFile) {
        if (videoUrl) {
            URL.revokeObjectURL(videoUrl);
        }
        videoUrl = URL.createObjectURL(videoFile);
        videoPlayer.src = videoUrl;
        videoPlayer.load();

        const videoNameWithoutExt = videoFile.name.split('.').slice(0, -1).join('.');
        const expectedSrtName = `${videoNameWithoutExt.toLowerCase()}.srt`;
        const matchingSrtFile = filesArray.find(f => f.name.toLowerCase() === expectedSrtName);
        if (matchingSrtFile) {
            loadSrtFile(matchingSrtFile);
        } else if(srtFile) {
            loadSrtFile(srtFile);
        }
    } else if (srtFile) {
        loadSrtFile(srtFile);
    }
}

fileUpload.addEventListener('change', (event) => {
    handleFiles(event.target.files);
    event.target.value = null;
});

function loadSrtFile(file) {
    const track = videoPlayer.textTracks[0];
    if (!track) {
        console.error(lang.noTrackError);
        return;
    }
    track.mode = 'showing';
    const reader = new FileReader();
    reader.onload = function (e) {
        const srtContent = e.target.result;
        parseSrtAndAddCues(srtContent, track);
    };
    reader.readAsText(file, 'UTF-8');
}

volumeBooster.addEventListener('input', (event) => {
    if (gainNode) {
        const boostValue = parseFloat(event.target.value);
        gainNode.gain.value = boostValue;
        volumeLevel.textContent = `${Math.round(boostValue * 100)}%`;
    }
});

function hideControls() {
    if (!videoPlayer.paused && !controlsPanel.matches(':hover')) {
        controlsPanel.classList.add('hidden');
    }
}

function showControls() {
    controlsPanel.classList.remove('hidden');
    clearTimeout(inactivityTimeout);
    inactivityTimeout = setTimeout(hideControls, 3000);
}

videoPlayer.addEventListener('play', () => {
    if (!audioContext) setupAudioBooster();
    showControls();
});
videoPlayer.addEventListener('pause', showControls);
window.addEventListener('mousemove', showControls);

function parseSrtAndAddCues(srtContent, track) {
    while (track.cues && track.cues.length > 0) {
        track.removeCue(track.cues[0]);
    }
    const cleanContent = srtContent.replace(/\r\n|\r/g, '\n').replace(/^\uFEFF/, '');
    const blocks = cleanContent.split('\n\n');
    for (const block of blocks) {
        const trimmedBlock = block.trim();
        if (!trimmedBlock) continue;
        const lines = trimmedBlock.split('\n');
        if (lines.length < 2) continue;
        const timestampLine = lines.find(line => line.includes('-->'));
        if (!timestampLine) continue;
        const timeMatch = timestampLine.match(/(\d{2}:\d{2}:\d{2}[,.]\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}[,.]\d{3})/);
        if (!timeMatch) continue;
        const startTime = timeStringToSeconds(timeMatch[1]);
        const endTime = timeStringToSeconds(timeMatch[2]);
        const cueText = lines.slice(lines.indexOf(timestampLine) + 1).join('\n');
        if (!isNaN(startTime) && !isNaN(endTime) && cueText) {
            const cue = new VTTCue(startTime, endTime, cueText);
            track.addCue(cue);
        }
    }
}

function timeStringToSeconds(timeString) {
    const [hms, ms] = timeString.replace(',', '.').split('.');
    const parts = hms.split(':');
    return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]) + (parseInt(ms) / 1000);
}

function setupAudioBooster() {
    if (audioContext) return;
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    audioContext = new AudioContext();
    if (audioContext.state === 'suspended') {
        audioContext.resume();
    }
    const source = audioContext.createMediaElementSource(videoPlayer);
    gainNode = audioContext.createGain();
    source.connect(gainNode);
    gainNode.connect(audioContext.destination);
    gainNode.gain.value = parseFloat(volumeBooster.value);
}

// Dra og slipp
document.body.addEventListener('dragover', (e) => {
    e.preventDefault();
});
document.body.addEventListener('drop', (e) => {
    e.preventDefault();
    handleFiles(e.dataTransfer.files);
});

// Tastatursnarveier
document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT') return;
    switch (e.key) {
        case ' ':
            e.preventDefault();
            videoPlayer.paused ? videoPlayer.play() : videoPlayer.pause();
            break;
        case 'f':
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                document.body.requestFullscreen();
            }
            break;
        case 'm':
            videoPlayer.muted = !videoPlayer.muted;
            break;
        case 'ArrowRight':
            videoPlayer.currentTime += 5;
            break;
        case 'ArrowLeft':
            videoPlayer.currentTime -= 5;
            break;
    }
});

updateStaticUIText();
showControls();
</script>
</body>
</html>